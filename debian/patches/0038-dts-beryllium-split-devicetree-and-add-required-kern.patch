From 995b8ff63f12c5d6f7d167c585d1e55b1f2fead9 Mon Sep 17 00:00:00 2001
From: venji10 <venji10@riseup.net>
Date: Tue, 4 May 2021 19:41:43 +0200
Subject: [PATCH 38/45] dts: beryllium: split devicetree and add required
 kernel configs

---
 arch/arm64/boot/dts/qcom/Makefile             |   3 +-
 ...ts => sdm845-xiaomi-beryllium-common.dtsi} |  27 +---
 .../dts/qcom/sdm845-xiaomi-beryllium-ebbg.dts | 136 ++++++++++++++++++
 .../qcom/sdm845-xiaomi-beryllium-tianma.dts   |  31 ++++
 arch/arm64/configs/sdm845.config              |   2 +
 5 files changed, 175 insertions(+), 24 deletions(-)
 rename arch/arm64/boot/dts/qcom/{sdm845-xiaomi-beryllium.dts => sdm845-xiaomi-beryllium-common.dtsi} (95%)
 create mode 100644 arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-ebbg.dts
 create mode 100644 arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-tianma.dts

diff --git a/arch/arm64/boot/dts/qcom/Makefile b/arch/arm64/boot/dts/qcom/Makefile
index 549a7a2151d4..101d75611dce 100644
--- a/arch/arm64/boot/dts/qcom/Makefile
+++ b/arch/arm64/boot/dts/qcom/Makefile
@@ -53,7 +53,8 @@ dtb-$(CONFIG_ARCH_QCOM)	+= sdm845-db845c.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= sdm845-mtp.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= sdm845-oneplus-enchilada.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= sdm845-oneplus-fajita.dtb
-dtb-$(CONFIG_ARCH_QCOM)	+= sdm845-xiaomi-beryllium.dtb
+dtb-$(CONFIG_ARCH_QCOM)	+= sdm845-xiaomi-beryllium-ebbg.dtb
+dtb-$(CONFIG_ARCH_QCOM) += sdm845-xiaomi-beryllium-tianma.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= sdm850-lenovo-yoga-c630.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= sm8150-hdk.dtb
 dtb-$(CONFIG_ARCH_QCOM)	+= sm8150-mtp.dtb
diff --git a/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium.dts b/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-common.dtsi
similarity index 95%
rename from arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium.dts
rename to arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-common.dtsi
index 4cb4ba2aa34d..385851e10b10 100644
--- a/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium.dts
+++ b/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-common.dtsi
@@ -223,8 +223,8 @@ &dsi0 {
 	#address-cells = <1>;
 	#size-cells = <0>;
 
-	panel@0 {
-		compatible = "tianma,fhd-video";
+	display_panel: panel@0 {
+		status = "disabled";
 		reg = <0>;
 		vddi0-supply = <&vreg_l14a_1p8>;
 		vddpos-supply = <&lab>;
@@ -236,7 +236,7 @@ panel@0 {
 		reset-gpios = <&tlmm 6 GPIO_ACTIVE_LOW>;
 
 		port {
-			tianma_nt36672a_in_0: endpoint {
+			panel_in_0: endpoint {
 				remote-endpoint = <&dsi0_out>;
 			};
 		};
@@ -244,7 +244,7 @@ tianma_nt36672a_in_0: endpoint {
 };
 
 &dsi0_out {
-	remote-endpoint = <&tianma_nt36672a_in_0>;
+	remote-endpoint = <&panel_in_0>;
 	data-lanes = <0 1 2 3>;
 };
 
@@ -339,25 +339,6 @@ tas2559_codec: tas2559@4c{
 	};
 };
 
-&i2c14 {
-	#dma-cells = <3>;
-	status="okay";
-
-	dmas =  <&gpi_dma1 0 6 QCOM_GPI_I2C>,
-			<&gpi_dma1 1 6 QCOM_GPI_I2C>;
-	dma-names = "tx", "rx";
-
-		touchscreen: novatek@62 {
-				compatible = "novatek,nt36525"; /* Should be novatek,nt36672A instead #TODO */
-				reg = <0x62>;
-				vdd-supply = <&vreg_l14a_1p8>;
-				interrupt-parent = <&tlmm>;
-				interrupts = <31 IRQ_TYPE_EDGE_RISING>;
-				reset-gpio = <&tlmm 32 0x00 /* GPIO_ACTIVE_HIGH */ >;
-		};
-
-};
-
 &pm8998_gpio {
 	vol_up_pin_a: vol-up-active {
 		pins = "gpio6";
diff --git a/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-ebbg.dts b/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-ebbg.dts
new file mode 100644
index 000000000000..c7518b79be21
--- /dev/null
+++ b/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-ebbg.dts
@@ -0,0 +1,136 @@
+// SPDX-License-Identifier: GPL-2.0
+
+/dts-v1/;
+
+#include "sdm845-xiaomi-beryllium-common.dtsi"
+
+&tlmm {
+
+	sde_dsi_active: sde_dsi_active {
+		mux {
+			pins = "gpio6", "gpio52";
+			function = "gpio";
+		};
+
+		config {
+			pins = "gpio6", "gpio52";
+			drive-strength = <8>;   /* 8 mA */
+			bias-disable = <0>;   /* no pull */
+		};
+	};
+
+	sde_dsi_suspend: sde_dsi_suspend {
+		mux {
+			pins = "gpio6", "gpio52";
+			function = "gpio";
+		};
+
+		config {
+			pins = "gpio6", "gpio52";
+			drive-strength = <2>;   /* 2 mA */
+			bias-pull-down;         /* PULL DOWN */
+		};
+	};
+};
+
+
+&display_panel {
+
+        status = "okay";
+
+	reset-gpios = <&tlmm 6 GPIO_ACTIVE_HIGH>;
+
+	pinctrl-names = "panel_active", "panel_suspend";
+	pinctrl-0 = <&sde_dsi_active>;
+	pinctrl-1 = <&sde_dsi_suspend>;
+
+        compatible = "ebbg,ft8719";
+
+};
+
+&tlmm {
+	ts_mux {
+
+		ts_int_active: ts_int_active {
+			mux {
+				pins = "gpio31";
+				function = "gpio";
+			};
+
+			config {
+				pins = "gpio31";
+				drive-strength = <16>;
+				bias-pull-down;
+				input-enable;
+			};
+		};
+
+		ts_reset_active: ts_reset_active {
+			mux {
+				pins = "gpio32";
+				function = "gpio";
+			};
+
+			config {
+				pins = "gpio32";
+				drive-strength = <16>;
+				output-high;
+			};
+		};
+
+		ts_reset_suspend: ts_reset_suspend {
+			mux {
+				pins = "gpio32";
+				function = "gpio";
+			};
+
+			config {
+				pins = "gpio32";
+				drive-strength = <2>;
+				bias-disable;
+				output-low;
+			};
+		};
+
+		ts_int_suspend: ts_int_suspend {
+			mux {
+				pins = "gpio31";
+				function = "gpio";
+			};
+
+			config {
+				pins = "gpio31";
+				drive-strength = <2>;
+				bias-pull-down;
+				input-enable;
+			};
+		};
+	};
+};
+
+&i2c14 {
+	status="okay";
+
+	dmas =  <&gpi_dma1 0 6 QCOM_GPI_I2C>,
+		<&gpi_dma1 1 6 QCOM_GPI_I2C>;
+	dma-names = "tx", "rx";
+
+	touchscreen: focaltech@38 {
+		compatible = "focaltech,fts";
+		reg = <0x38>;
+		interrupt-parent = <&tlmm>;
+		interrupts = <31 0>;
+		vddio-supply = <&vreg_l14a_1p8>;
+		lab-supply = <&lab>;
+		ibb-supply = <&ibb>;
+
+		focaltech,reset-gpio = <&tlmm 32 0x01>;
+		focaltech,irq-gpio = <&tlmm 31 0x02>;
+		focaltech,max-touch-number = <10>;
+		focaltech,display-coords = <0 0 1080 2246>;
+		pinctrl-names = "pmx_ts_active", "pmx_ts_suspend";
+		pinctrl-0 = <&ts_int_active &ts_reset_active>;
+		pinctrl-1 = <&ts_int_suspend &ts_reset_suspend>;
+	};
+};
+
diff --git a/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-tianma.dts b/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-tianma.dts
new file mode 100644
index 000000000000..01237669051c
--- /dev/null
+++ b/arch/arm64/boot/dts/qcom/sdm845-xiaomi-beryllium-tianma.dts
@@ -0,0 +1,31 @@
+// SPDX-License-Identifier: GPL-2.0
+
+/dts-v1/;
+
+#include "sdm845-xiaomi-beryllium-common.dtsi"
+
+&display_panel {
+
+	status = "okay";
+	compatible = "tianma,fhd-video";
+
+};
+
+&i2c14 {
+	status = "okay";
+
+	dmas =  <&gpi_dma1 0 6 QCOM_GPI_I2C>,
+		<&gpi_dma1 1 6 QCOM_GPI_I2C>;
+	dma-names = "tx", "rx";
+
+	touchscreen: novatek@62 {
+		compatible = "novatek,nt36525"; /* Should be novatek,nt36672A instead #TODO */
+		reg = <0x62>;
+		vdd-supply = <&vreg_l14a_1p8>;
+		interrupt-parent = <&tlmm>;
+		interrupts = <31 IRQ_TYPE_EDGE_RISING>;
+		reset-gpio = <&tlmm 32 0x00 /* GPIO_ACTIVE_HIGH */ >;
+	};
+
+};
+
diff --git a/arch/arm64/configs/sdm845.config b/arch/arm64/configs/sdm845.config
index a4573b3efb94..1928085e4487 100644
--- a/arch/arm64/configs/sdm845.config
+++ b/arch/arm64/configs/sdm845.config
@@ -14,7 +14,9 @@ CONFIG_RMI4_F55=y
 
 # Pocophone F1
 CONFIG_DRM_PANEL_NOVATEK_NT36672A=y
+CONFIG_DRM_PANEL_EBBG_FHD_FT8719=y
 CONFIG_TOUCHSCREEN_NT36XXX=m
+CONFIG_TOUCHSCREEN_FTS=m
 CONFIG_QCOM_GPI_DMA=m
 CONFIG_SND_SOC_TAS2559=m
 
-- 
2.30.2

